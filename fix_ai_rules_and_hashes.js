const fs = require('fs-extra');

async function structureAiRulesAndRemoveHashes() {
    console.log('ğŸ§¹ AI Rulesã®æ•´å‚™ã¨ä¸è¦ãª###ã®å‰Šé™¤ã‚’è¡Œã„ã¾ã™...');

    const TARGET_FILE = '/Users/kino/Desktop/vibe_coding_master.md';
    let content = await fs.readFile(TARGET_FILE, 'utf8');

    // 1. ### ã€...ã€‘ ã® ### ã‚’å‰Šé™¤ã™ã‚‹
    // ç¾çŠ¶: **### ã€ã‚³ãƒ”ãƒšç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**ã€‘ ã¿ãŸã„ãªå¤‰ãªçŠ¶æ…‹ã‹ã‚‚ï¼Ÿ
    // grepçµæœ: "659:**### ã€ã‚³ãƒ”ãƒšç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**ã€‘"
    // æ­£è¦è¡¨ç¾ã§ã€**###ã€###**ã€ã‚ã‚‹ã„ã¯å˜ã« ### ã‚’ã€ã®å‰ã‹ã‚‰æ¶ˆã™ã€‚

    // ãƒ‘ã‚¿ãƒ¼ãƒ³: (**)### (**)ã€ -> (**)ã€
    // å˜ç´”ã« "### " ã‚’æ¶ˆã›ã°ã„ã„ãŒã€å¤ªå­—è¨˜å·ã¨ã®å…¼ã­åˆã„ã‚’èª¿æ•´ã€‚

    // æˆ¦ç•¥: è¡Œã®ä¸­ã« "### ã€" ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰ã€"### " ã‚’å‰Šé™¤ã™ã‚‹ã€‚
    // ã‚‚ã— "**###" ãªã‚‰ "###"å‰Šé™¤ã§ "**" ãŒæ®‹ã‚‹ -> æ­£ã—ã„ã€‚

    content = content.replace(/###\s*(?=ã€)/g, '');

    // ä»–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚ã‚±ã‚¢
    // "### ã€" (ã‚¹ãƒšãƒ¼ã‚¹ã‚ã‚Š) -> å‰Šé™¤
    // "###ã€" (ã‚¹ãƒšãƒ¼ã‚¹ãªã—) -> å‰Šé™¤
    content = content.replace(/###(?=ã€)/g, '');


    // 2. AI Rules ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®ãã‚Œã„ãªMarkdownã«å·®ã—æ›¿ãˆã‚‹
    // æŒ¿å…¥ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå…¨ä½“ã‚’ > ã§å›²ã‚€ï¼‰

    const aiRulesRaw = `**AI Rules & Guidelines (Vibe Coding & Security Master)**

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãŠã‘ã‚‹AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆã‚ãªãŸï¼‰ã®è¡Œå‹•æŒ‡é‡ã‚’å®šã‚ãŸã‚‚ã®ã§ã™ã€‚ **æœ€ä¸Šä½å‘½ä»¤**ã¨ã—ã¦ã€ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ã‚’å•ã‚ãšã€å…¨ã¦ã®ä½œæ¥­ã«ãŠã„ã¦ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å¸¸ã«éµå®ˆã—ã¦ãã ã•ã„ã€‚

**1. é–‹ç™ºé–‹å§‹ã®å„€å¼ï¼šè¦ä»¶å®šç¾©ã¨ \`ANTIGRAVITY.md\`**

- **ãƒ«ãƒ¼ãƒ«ï¼šç‹¬è‡ªã®åˆ¤æ–­ã§å®Ÿè£…ã‚’é–‹å§‹ã—ãªã„**
  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°ã—ã„ã‚¢ãƒ—ãƒªä½œæˆã‚„æ–°æ©Ÿèƒ½é–‹ç™ºã‚’å¸Œæœ›ã—ãŸéš›ã¯ã€å³åº§ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã®ã§ã¯ãªãã€ã¾ãšã€Œè¦ä»¶å®šç¾©ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ã‚’èµ·å‹•ã—ã€ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚’é–‹å§‹ã™ã‚‹ã“ã¨ã€‚

- **æ‰‹é †**:
  1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œç›®çš„ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã€åˆ©ç”¨ã‚·ãƒ¼ãƒ³ã€ãªã©ã‚’1ã¤ãšã¤è³ªå•ã™ã‚‹ã€‚
  2. ãƒ’ã‚¢ãƒªãƒ³ã‚°å†…å®¹ã«åŸºã¥ãã€ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå°‚ç”¨ã® \`ANTIGRAVITY.md\` ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ†²æ³•ï¼‰ã‚’ä½œæˆã¾ãŸã¯æ›´æ–°ã™ã‚‹ã“ã¨ã€‚
     â€»ã‚·ã‚¹ãƒ†ãƒ æ¨™æº–ã® \`task.md\`ï¼ˆçŸ­æœŸã‚¿ã‚¹ã‚¯ç®¡ç†ï¼‰ã¨ã¯æ˜ç¢ºã«åŒºåˆ¥ã—ã€é•·æœŸçš„ãƒ»åŒ…æ‹¬çš„ãªä»•æ§˜æ›¸ã¨ã—ã¦é‹ç”¨ã™ã‚‹ã€‚
  3. \`ANTIGRAVITY.md\` ã«ã¯ã€ŒMVPã®ç¯„å›²ã€ã€ŒæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã€ã€Œç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã€ã‚’æ˜è¨˜ã™ã‚‹ã“ã¨ã€‚

**2. é–‹ç™ºæˆ¦ç•¥ï¼šMVPï¼ˆæœ€å°æ§‹æˆï¼‰åŸå‰‡**

- **ãƒ«ãƒ¼ãƒ«ï¼šæ®µéšçš„é–‹ç™ºã®å¾¹åº•**
  è¤‡é›‘ãªå®Ÿè£…ã§ã‚ã£ã¦ã‚‚ã€å¸¸ã«ã€Œæœ€å°é™ã®å®Ÿç”¨å¯èƒ½ãªè£½å“ï¼ˆMVPï¼‰ã€ã‹ã‚‰ç€æ‰‹ã™ã‚‹ã“ã¨ã€‚æ ¸ã¨ãªã‚‹æ©Ÿèƒ½ã®ã¿ã®å®Ÿè¡Œè¨ˆç”»ã‚’æç¤ºã—ã€å‹•ä½œç¢ºèªï¼ˆå‘³è¦‹ï¼‰ãŒå®Œäº†ã—ã¦ã‹ã‚‰æ¬¡ã®æ©Ÿèƒ½ã‚’è‚‰ä»˜ã‘ã™ã‚‹ã“ã¨ã€‚

- **ç›®çš„**: AIã®è¨˜æ†¶æ··æ¿ã‚’é˜²ãã€ã‚¨ãƒ©ãƒ¼ç‰¹å®šã‚’å®¹æ˜“ã«ã—ã€æœ€é€Ÿã§ã€Œå‹•ãä½“é¨“ã€ã‚’æä¾›ã™ã‚‹ãŸã‚ã€‚

**3. å®‰å…¨ç®¡ç† & éç ´å£Šæ“ä½œã®ç¸›ã‚Š**

- **ãƒ«ãƒ¼ãƒ«1ï¼šä½œæ¥­å‰ã®ç¢ºèª (y/n)**
  ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ã€ãŠã‚ˆã³ç ´å£Šçš„ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œå‰ã«ã€å¿…ãšä½œæ¥­è¨ˆç”»ã‚’å ±å‘Šã—ã€ã€Œy/nã€ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªã‚’å–ã‚‹ã“ã¨ã€‚
  *ä¾‹å¤–: \`ls\`ã‚„\`cat\`ã€\`grep\`ãªã©ã®ã€Œéç ´å£Šçš„ãªèª­ã¿å–ã‚Šãƒ»èª¿æŸ»æ“ä½œã€ã«ã¤ã„ã¦ã¯ã€é–‹ç™ºãƒ†ãƒ³ãƒï¼ˆVibeï¼‰ã‚’å„ªå…ˆã—ã€äº‹å¾Œå ±å‘Šã¾ãŸã¯ãã®å ´ã®åˆ¤æ–­ã§å®Ÿè¡Œã—ã¦ã‚‚ã‚ˆã„ã€‚*

- **ãƒ«ãƒ¼ãƒ«2ï¼šéç ´å£Šæ“ä½œãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ï¼ˆæœ€ä¸Šä½ç¸›ã‚Šï¼‰**
  ä»¥ä¸‹ã®æ“ä½œã‚’è¡Œã†éš›ã¯ã€å¿…ãšãã®ç†ç”±ã¨ãƒªã‚¹ã‚¯ã‚’æ˜ç¤ºã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ˜ç¢ºãªå€‹åˆ¥è¨±å¯ã‚’å¾—ã‚‹ã“ã¨ã€‚
  - \`rm\`ï¼ˆå‰Šé™¤ï¼‰ã‚„ \`sudo\`ï¼ˆç®¡ç†è€…æ¨©é™ï¼‰ã‚’ä¼´ã†ã‚³ãƒãƒ³ãƒ‰ã€‚
  - æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ\`.env\`, \`id\_rsa\` ç­‰ï¼‰ã®èª­ã¿å–ã‚Šã‚„å¤‰æ›´ã€‚
  - æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’åºƒç¯„å›²ã«ä¸€æ‹¬ä¸Šæ›¸ãã™ã‚‹ç ´å£Šçš„ãªå¤‰æ›´ã€‚

**4. å…¨ä¸–ç•Œå…¬é–‹æ™‚ã®å¼·åˆ¶ç›£æŸ»**

- **ãƒ«ãƒ¼ãƒ«ï¼šãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ãƒ—ãƒƒã‚·ãƒ¥å‰ã®ã€Œå®ˆã‚Šã®ä¸‰æŸ±ã€ææ¡ˆ**
  ã‚¢ãƒ—ãƒªã‚’ã€Œå…¨ä¸–ç•Œã«å…¬é–‹ã€ã™ã‚‹æ“ä½œã®ç›´å‰ã«ã¯ã€å¿…ãšä»¥ä¸‹ã®3ç‚¹ã‚’è‡ªã‚‰ææ¡ˆãƒ»ç›£æŸ»ã—ã€æ‰¿èªã‚’å¾—ã‚‹ã“ã¨ã€‚
  1. **æŠ€è¡“çš„é˜²å¾¡ (RLS)**: å…¨ã¦ã®DBãƒ†ãƒ¼ãƒ–ãƒ«ã«é©åˆ‡ãªRLSï¼ˆè¡Œãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã€‚
  2. **æ³•çš„é˜²å¾¡ (è¦ç´„ç­‰)**: åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ãƒ»ç‰¹å•†æ³•è¡¨è¨˜ã®è¨­ç½®ã€‚
  3. **é€šä¿¡ã®å®‰å…¨ (HTTPS)**: é€šä¿¡ãŒæš—å·åŒ–ï¼ˆSSLï¼‰ã•ã‚Œã¦ã„ã‚‹ã‹ã€‚

**5. ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ & ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚° (Conduct)**

- **è¨€èª**: å…¨ã¦ **æ—¥æœ¬èª** ã§å¿œç­”ãƒ»è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚
- **ãƒˆãƒ¼ãƒ³**: è¦ªã—ã¿ã‚„ã™ãã€è«–ç†çš„ã§åˆ†ã‹ã‚Šã‚„ã™ã„èª¬æ˜ã€‚å¿…è¦ã«å¿œã˜ã¦ã€Œæ–™ç†å‹é–‹ç™ºã€ã€ŒãŠåº—ã®è­¦å‚™ã€ãªã©ã®æ¯”å–©ã‚’ç”¨ã„ã‚‹ã“ã¨ã€‚
- **æ§‹æˆ**: æ‰‹é †ï¼ˆHowï¼‰ã®å‰ã«ã€å¿…ãšç†ç”±ï¼ˆWhyï¼‰ã¨å®Œäº†å¾Œã®ãƒ™ãƒãƒ•ã‚£ãƒƒãƒˆã‚’æç¤ºã™ã‚‹ã“ã¨ã€‚

**6. é‹ç”¨ãƒ»æˆæœç‰© (Operations & Outputs)**

- **ãƒ«ãƒ¼ãƒ«ï¼šå®Œå…¨æ—¥æœ¬èªåŒ–**
  - ãƒãƒ£ãƒƒãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ä»˜ã‘ã€ã‚³ãƒ¼ãƒ‰å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€åŸå‰‡ã¨ã—ã¦ **æ—¥æœ¬èª** ã§è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚
  - **ã‚·ã‚¹ãƒ†ãƒ è¡¨ç¤ºã®æ—¥æœ¬èªåŒ–**: AIãŒæç¤ºã™ã‚‹ã€Œã‚¿ã‚¹ã‚¯åã€ã€Œå®Ÿæ–½å†…å®¹ï¼ˆTask Statusï¼‰ã€ã€Œé€²æ—çŠ¶æ³ã€ãªã©ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ã€å…¨ã¦ **æ—¥æœ¬èª** ã§è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚
`;

    // å…¨è¡Œã« `> ` ã‚’ã¤ã‘ã‚‹é–¢æ•°
    const quotedAiRules = aiRulesRaw.split('\n').map(line => `> ${line}`).join('\n');

    // ç½®æ›å¯¾è±¡ã®ç‰¹å®š
    // ç¾åœ¨ã®AI Rulesã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯
    // "> > > > **AI Rules & Guidelines ..." ã§å§‹ã¾ã£ã¦ã„ã‚‹ï¼ˆgrepçµæœã‚ˆã‚Šï¼‰
    // ãã—ã¦ã€æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ3.3ã‚ãŸã‚Šï¼‰ã®å‰ã¾ã§ç¶šãã€‚

    const startString = '> > > > **AI Rules & Guidelines';
    // çµ‚äº†åœ°ç‚¹ã‚’æ¢ã™ã®ãŒé›£ã—ã„ãŒã€"3.3 Node.js ã®å½¹å‰²" ã®ç›´å‰ã¾ã§ã€ã‚ã‚‹ã„ã¯ ";yb" ã¾ã§ã€‚
    // å‰å›ã®grepã§ ";yb" ãŒè¦‹ãˆãŸã®ã§ã€ãã“ã¾ã§ã‚’ç½®æ›ã™ã‚‹ã®ãŒè‰¯ã•ãã†ã€‚

    // ã—ã‹ã—ã€grepçµæœã‚’è¦‹ã‚‹ã¨513è¡Œç›®ã‹ã‚‰å§‹ã¾ã£ã¦ã„ã‚‹ã€‚
    // ";yb" ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ”ãƒšãƒŸã‚¹ã£ã½ã„ãŒã€ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«æ®‹ã£ã¦ã„ã‚‹ãªã‚‰ç›®å°ã«ãªã‚‹ã€‚

    // å®‰å…¨ã«ã‚„ã‚‹ãªã‚‰ã€"AI Rules & Guidelines" ã‚’å«ã‚€è¡Œã‹ã‚‰ã€
    // "### 3.3 Node.js" (ã¾ãŸã¯ "<h2 "åŒ–ã•ã‚ŒãŸè¦‹å‡ºã—) ã®å‰ã«ã‚ã‚‹ç”»åƒ "![]..." ã®å‰ã¾ã§ã€‚

    const startIndex = content.indexOf('**AI Rules & Guidelines');
    // ãã®å°‘ã—å‰ã® `> > > > ` ã‚‚å«ã‚ãŸã„ã®ã§ã€è¡Œé ­ã‚’æ¢ã™

    if (startIndex !== -1) {
        // startLineã‚’è¦‹ã¤ã‘ã‚‹
        const before = content.substring(0, startIndex);
        const startLineHeader = before.lastIndexOf('\n') + 1;

        // çµ‚äº†åœ°ç‚¹: "### 3.3" ã®å‰ã€ã‚ã‚‹ã„ã¯ "Next, PCã«..." ã®å‰
        // grepçµæœã§ã¯ 3.3 ã®å‰ã«ç”»åƒãŒã‚ã‚‹ã€‚
        // "### 3.3 Node.js" ã‚’æ¢ã™ã®ãŒæ‰‹å …ã„ã€‚
        // ãŸã ã—ã€hardcode_html_links.jsã§HTMLåŒ–ã—ã¦ã„ã‚‹ã‹ï¼Ÿ
        // AI Rulesã¯ç¬¬3ç« ã®é€”ä¸­ã‚ã‚‹ã„ã¯ç›´å¾Œã«æŒ¿å…¥ã•ã‚Œã¦ã„ã‚‹ã¯ãšã€‚
        // grep 513è¡Œç›®ã€‚ 3.3 Node.js ã¯ 572è¡Œç›®ã€‚

        // "3.3 Node.js" ã‚’æ¢ã™
        const endMarker = 'Node.js ã®å½¹å‰²ï¼ˆãªãœå¿…è¦ã‹ï¼‰';
        const searchFrom = content.substring(startIndex);
        const relativeEndIndex = searchFrom.indexOf(endMarker);

        if (relativeEndIndex !== -1) {
            // "### 3.3" ã®è¡Œé ­ã¾ã§æˆ»ã‚‹
            // ãŸã ã—ã€ãã®å‰ã«ç”»åƒãŒã‚ã‚‹: ![](images/external_image_14.jpg)
            // ç”»åƒã®æ‰‹å‰ã¾ã§ã‚’AI Rulesã®ç¯„å›²ã¨ã™ã‚‹ã€‚

            // searchFromã®ä¸­ã§ç”»åƒã‚’æ¢ã™
            const imageMarker = '![](images/external_image_14.jpg)';
            const relativeImageIndex = searchFrom.indexOf(imageMarker);

            let cutLength;
            if (relativeImageIndex !== -1 && relativeImageIndex < relativeEndIndex) {
                // ç”»åƒã®æ‰‹å‰ã€ãŸã¶ã‚“æ”¹è¡Œ2ã¤åˆ†ãã‚‰ã„å‰
                cutLength = relativeImageIndex;
            } else {
                // è¦‹å‡ºã—ã®æ‰‹å‰
                // "### 3.3 " ã‚ã‚‹ã„ã¯ "<h3 ...>3.3 "
                cutLength = relativeEndIndex;
                // ã‚‚ã†å°‘ã—æˆ»ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼ˆè¡Œé ­ã¾ã§ï¼‰
            }

            // startLineHeader ã‹ã‚‰ (startIndex + cutLength) ã¾ã§ã‚’ç½®æ›
            const finalEndIndex = startIndex + cutLength;

            // ç½®æ›å®Ÿè¡Œ
            // å‰å¾Œã®ç©ºç™½ã‚’èª¿æ•´
            const beforeContent = content.substring(0, startLineHeader);
            const afterContent = content.substring(finalEndIndex);

            // quotesAiRulesã®æœ€å¾Œã®ç©ºè¡Œèª¿æ•´
            content = beforeContent + quotedAiRules + '\n\n' + afterContent;

            console.log('âœ… AI Rulesã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãã‚Œã„ã«æ•´å½¢ã—ã¦ç½®æ›ã—ã¾ã—ãŸ');
        } else {
            console.warn('âš ï¸ AI Rulesã®çµ‚äº†ä½ç½®ï¼ˆNode.jsã®å½¹å‰²ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        }
    } else {
        console.warn('âš ï¸ AI Rulesã®é–‹å§‹ä½ç½®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }

    await fs.writeFile(TARGET_FILE, content, 'utf8');
}

structureAiRulesAndRemoveHashes().catch(console.error);
