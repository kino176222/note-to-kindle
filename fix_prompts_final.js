const fs = require('fs-extra');

async function fixPrompts() {
    console.log('ğŸ—£ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåŒ–æ¼ã‚Œï¼ˆruby...ï¼‰ã‚’å¾¹åº•çš„ã«æ‘˜ç™ºã—ã€å¼•ç”¨ãƒ–ãƒ­ãƒƒã‚¯ã¸åç›£ã—ã¾ã™...');

    const TARGET_FILE = '/Users/kino/Desktop/vibe_coding_master.md';
    let content = await fs.readFile(TARGET_FILE, 'utf8');

    // ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³:
    // 1. "ruby Antigravity..."
    // 2. "ruby > ã‚µãƒ¼ãƒãƒ¼ã‚’..."
    // 3. "ruby ã€Œãƒ‡ã‚¶ã‚¤ãƒ³ãŒåœ°å‘³..."

    // ã“ã‚Œã‚‰ã¯æœ¬æ¥ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå¼•ç”¨ãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã§ã‚ã‚‹ã¹ãã€‚
    // æ–‡é ­ã® "ruby " ã‚„ "ruby > " ã‚’å‰Šé™¤ã—ã€ãã®æ®µè½å…¨ä½“ã‚’å¼•ç”¨åŒ–ã™ã‚‹ã€‚

    // æˆ¦ç•¥:
    // è¡Œé ­ã« "ruby" ãŒã‚ã‚‹ç®‡æ‰€ã‚’æ¢ã—ã€ãã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‡¦ç†ã™ã‚‹ã€‚

    const lines = content.split('\n');
    let inRubyBlock = false;
    let newLines = [];

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        // rubyã®é–‹å§‹è¡Œæ¤œçŸ¥
        if (line.trim().startsWith('ruby')) {
            // "ruby > " ã‚„ "ruby " ã‚’å‰Šé™¤
            line = line.replace(/^ruby\s*(>)?\s*/, '');
            // å¼•ç”¨è¨˜å·ã‚’ã¤ã‘ã‚‹
            line = `> ${line}`;

            // ãƒ–ãƒ­ãƒƒã‚¯å†…ãƒ•ãƒ©ã‚°ONï¼ˆæ¬¡ã®ç©ºè¡Œã¾ã§ç¶šãï¼‰
            if (line.trim() !== '>') { // ã¾ã‚Œã«ç©ºè¡Œã®ã“ã¨ã‚‚ã‚ã‚‹ã®ã§
                // æ—¢ã«å¼•ç”¨è¨˜å·ãŒã¤ã„ã¦ã„ã‚‹å ´åˆã¯é‡è¤‡ã—ãªã„ã‚ˆã†ã«æ³¨æ„ã™ã‚‹ãŒã€
                // ã“ã“ã§ã¯ã€Œrubyã€å–ã£ãŸã®ã§ã¤ã„ã¦ãªã„ã¯ãšã€‚
            }
        } else if (line.trim().startsWith('> ruby')) {
            // æ—¢ã«å¼•ç”¨å†…ã«ã‚ã‚‹ãŒ "ruby" ãŒæ®‹ã£ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹
            line = line.replace('> ruby', '> ');
        }

        newLines.push(line);
    }

    content = newLines.join('\n');

    // ã‚‚ã†ä¸€åº¦å…¨ä½“ã‚’è¦‹ã¦ã€ "ruby " ãŒæ®‹ã£ã¦ã„ãªã„ã‹ç¢ºèªç½®æ›ï¼ˆå¿µã®ãŸã‚ï¼‰
    // ç‰¹ã«ã€ä¸Šè¨˜ãƒ«ãƒ¼ãƒ—ã§ã¯ãƒ–ãƒ­ãƒƒã‚¯ç¶™ç¶šï¼ˆè¤‡æ•°è¡Œï¼‰ã«å¯¾å¿œã—ãã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€
    // æ­£è¦è¡¨ç¾ã§ä¸€æ‹¬ç½®æ›ã‚‚ä½µç”¨ã™ã‚‹ã€‚

    // "ruby " ã§å§‹ã¾ã‚‹æ®µè½ã‚’æ•æ‰ã—ã€å¼•ç”¨åŒ–
    // ãŸã ã—ã€æ—¢ã«å¼•ç”¨ï¼ˆ>ï¼‰ã®ä¸­ã«ã‚ã‚‹å ´åˆã¯ç„¡è¦–ã—ãŸã„ãŒã€å˜ç´”ç½®æ›ã§ã„ã„ã€‚
    // èª¤çˆ†é˜²æ­¢ã®ãŸã‚ã€æ–‡é ­(^)ã®ã¿ãƒãƒƒãƒã•ã›ã‚‹

    content = content.replace(/^ruby ([\s\S]*?)(?=\n\n|\n#)/gm, (match, body) => {
        return '> ' + body.replace(/\n/g, '\n> '); // è¤‡æ•°è¡Œã‚‚å…¨éƒ¨å¼•ç”¨ã«
    });

    // "ruby > " ã¨ã„ã†å¤‰ãªæ®‹ã‚Šã‚«ã‚¹ã‚‚æ¶ˆã™
    content = content.replace(/^ruby > /gm, '> ');

    await fs.writeFile(TARGET_FILE, content, 'utf8');
    console.log('âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåŒ–ä¿®å¾©ä»»å‹™å®Œäº†');
}

fixPrompts().catch(console.error);
