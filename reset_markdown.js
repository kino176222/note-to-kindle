const fs = require('fs-extra');
const path = require('path');

async function resetAndRefineMarkdown() {
    console.log('ğŸ”„ Markdownã®ãƒªã‚»ãƒƒãƒˆã¨æ­£è¦åŒ–ã‚’é–‹å§‹ã—ã¾ã™...');

    const TARGET_FILE = '/Users/kino/Desktop/vibe_coding_master.md';
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã™ã‚‹ã‹ã€ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¼·åŠ›ã«ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹
    // ä»Šå›ã¯ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€æ··å…¥ã—ãŸHTMLã‚¿ã‚°ã‚„å¤‰ãªMarkdownè¨˜æ³•ã‚’é™¤å»ã—ã¾ã™

    let content = await fs.readFile(TARGET_FILE, 'utf8');

    // 1. æ··å…¥ã—ãŸHTMLã‚¿ã‚°ã®å‰Šé™¤ (<div>ãªã©)
    // ç‰¹ã«å‰å›æ··å…¥ã—ãŸ <div style="..."> ãªã©ã‚’å‰Šé™¤
    content = content.replace(/<div[^>]*>/g, '');
    content = content.replace(/<\/div>/g, '');
    content = content.replace(/<span[^>]*>/g, '');
    content = content.replace(/<\/span>/g, '');
    content = content.replace(/<p[^>]*>/g, '');
    content = content.replace(/<\/p>/g, '');

    // 2. èª¤ã£ãŸã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®è§£é™¤
    // ç”»åƒãŒ ``` ã§å›²ã¾ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹å•é¡Œã‚’ä¿®æ­£
    // ä¾‹: ```\n![](...) \n``` -> ![](...)
    content = content.replace(/```\s*\n(!\[.*?\]\(.*?\))\s*\n```/g, '$1');

    // 3. çµµæ–‡å­—ã®ãƒ†ã‚­ã‚¹ãƒˆåŒ– (å¿µã®ãŸã‚å†å®Ÿè¡Œ)
    // ãƒ†ã‚­ã‚¹ãƒˆç½®æ›ãƒãƒƒãƒ—
    const emojiMap = {
        'âš ï¸': 'ã€æ³¨æ„ã€‘',
        'ğŸ’¡': 'ã€ãƒ’ãƒ³ãƒˆã€‘',
        'âœ…': '[âœ“]',
        'ğŸ‘‰': 'â†’',
        'â­•ï¸': 'ã€OKã€‘',
        'âŒ': 'ã€NGã€‘',
        'ğŸ¯': 'ã€ãƒã‚¤ãƒ³ãƒˆã€‘'
    };
    for (const [emoji, text] of Object.entries(emojiMap)) {
        content = content.replace(new RegExp(emoji, 'g'), text);
    }

    // 4. å¼·èª¿ã—ãŸã„éƒ¨åˆ†ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç­‰ï¼‰ã‚’ã€Œå¼•ç”¨è¡¨ç¤ºã€ã«ã™ã‚‹
    // ä»¥å‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ divåŒ–ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸç®‡æ‰€ãªã©ã‚’ > å¼•ç”¨ã«å¤‰æ›
    // "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹" ãªã©ã‚’ç‰¹å®šã™ã‚‹ã®ã¯é›£ã—ã„ãŒã€
    // ã“ã“ã§ã¯ã€ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€è¡Œã€ã¾ãŸã¯å‰å›ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯åŒ–ã—ã‚ˆã†ã¨ã—ãŸç®‡æ‰€ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹

    // User request: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®éƒ¨åˆ†ã¯ç°è‰²ã«ã—ã¦ãŠã„ãŸã»ã†ãŒã‚ˆã‹ã£ãŸ" 
    // -> EPUBã§ã¯å¼•ç”¨ (blockquote) ãŒæœ€ã‚‚å®‰å…¨ã§ç¶ºéº—ã«è¦‹ãˆã‚‹

    const prompts = [
        'ã‚¹ã‚¯ã‚·ãƒ§ã‚’æ·»ä»˜ã—ã¦ã€Œã“ã‚Œã©ã†ã„ã†æ„å‘³ï¼Ÿã€ã¨è³ªå•',
        'ã€Œãƒ†ã‚­ã‚¹ãƒˆã‚’æ—¥æœ¬èªã«ç›´ã—ã¦ã€',
        'ã€ŒèƒŒæ™¯ã‚’ç™½ã«ã—ã¦ã€'
    ];

    for (const prompt of prompts) {
        // ã™ã§ã«å¼•ç”¨ã«ãªã£ã¦ã„ã‚‹ã‚‚ã®ã‚’é¿ã‘ã‚‹ãŸã‚ã€ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰é©ç”¨
        // å˜ç´”ãªç½®æ›
        content = content.replace(prompt, `\n> ${prompt}\n`);
    }

    // ä¸è¦ãªé€£ç¶šæ”¹è¡Œã®å‰Šé™¤
    content = content.replace(/\n{4,}/g, '\n\n\n');

    // 5. AI Rulesã®ç›®æ¬¡é™¤å¤–å¯¾å¿œ (## -> **)
    // å‰å›ã‚„ã£ã¦ã„ã‚Œã°ãã®ã¾ã¾ã ãŒã€å´©ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§ç¢ºèª
    // # AI Rules ... ã®ä¸­èº«ã® ## ã‚’ ** ã«ã™ã‚‹å‡¦ç†ã¯ã€ã‚‚ã—å‰å›å´©ã‚Œã¦ã„ã‚Œã°ä¿®å¾©å›°é›£ã ãŒã€
    // ã‚·ãƒ³ãƒ—ãƒ«ã« ## ã‚’è¦‹ã¤ã‘ãŸã‚‰ ** ã«ã™ã‚‹ï¼ˆAI Rulesã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ã¿ï¼‰

    const aiRulesMatch = content.match(/# AI Rules[\s\S]*?(?=\n# |$)/);
    if (aiRulesMatch) {
        const aiRulesSection = aiRulesMatch[0];
        const fixedSection = aiRulesSection.replace(/^##\s+(.*)$/gm, '**$1**\n');
        content = content.replace(aiRulesSection, fixedSection);
    }

    // AI Rulesã®ã‚¿ã‚¤ãƒˆãƒ«è‡ªä½“ã‚’ç›®æ¬¡ã«å‡ºã—ãŸããªã„å ´åˆã€# ã§ã¯ãªãå¤§æ–‡å­—å¼·èª¿ãªã©ã«ã™ã‚‹æ‰‹ã‚‚ã‚ã‚‹ãŒ
    // ã“ã“ã§ã¯ # ã®ã¾ã¾ï¼ˆãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«è¦‹å‡ºã—ï¼‰ã«ã—ã¦ãŠãã‹ã€## ã«ä¸‹ã’ã‚‹ã‹ã€‚
    // Userè¦æœ›ã€Œç›®æ¬¡æ§‹æˆãŒå¤‰ã€ã‚’ç›´ã™ãŸã‚ã€AI Rulesè‡ªä½“ã‚’ã€Œä»˜éŒ²ã€æ‰±ã„ã«ã™ã‚‹
    // content = content.replace(/^# AI Rules/m, '## ä»˜éŒ²ï¼šAI Rules');

    // ä¿å­˜
    await fs.writeFile(TARGET_FILE, content, 'utf8');
    console.log('âœ… Markdownã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å®Œäº†');
}

resetAndRefineMarkdown().catch(console.error);
