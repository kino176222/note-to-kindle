const fs = require('fs-extra');

async function unwrapFalsePrompts() {
    console.log('ğŸš‘ èª¤ã£ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ‰±ã„ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’æ•‘å‡ºã—ã¾ã™...');

    const TARGET_FILE = '/Users/kino/Desktop/vibe_coding_master.md';
    let content = await fs.readFile(TARGET_FILE, 'utf8');

    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1: "æ¬¡ã«ã€PCã«ã€Œé­”æ³•...ã€" ã‹ã‚‰å§‹ã¾ã‚‹å¤§ããªãƒ–ãƒ­ãƒƒã‚¯
    // ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ã‹ãªã‚Šé•·ã„ã‚ˆã†ãªã®ã§ã€é–‹å§‹ç‚¹ã‹ã‚‰ç‰¹å®šã®çµ‚äº†ç‚¹ã¾ã§ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    // ç”»åƒã‚’è¦‹ã‚‹ã¨ã€"Node.js ã‚’å…¥ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã¯..." ã®å¾Œã€ "ã¾ãšã¯ã€ä»¥ä¸‹ã®å‘ªæ–‡ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’..." ã®ç›´å‰ã¾ã§ç¶šã„ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

    // æˆ¦ç•¥: ç‰¹å®šã®è¡Œã‚’è¦‹ã¤ã‘ã¦ã€ãã®è¡Œã® `> ` ã‚’å‰Šé™¤ã™ã‚‹ã€‚
    // ãƒ–ãƒ­ãƒƒã‚¯ã”ã¨å‰Šé™¤ã™ã‚‹ã®ã¯å±é™ºãªã®ã§ã€è¡Œå˜ä½ã§åˆ¤å®šã—ã¦å‰Šé™¤ã™ã‚‹ã€‚

    // è§£é™¤ã—ãŸã„è¡Œã«å«ã¾ã‚Œã‚‹ç‰¹å¾´çš„ãªãƒ•ãƒ¬ãƒ¼ã‚ºã®ãƒªã‚¹ãƒˆ
    const targetPhrases = [
        'æ¬¡ã«ã€PCã«ã€Œé­”æ³•ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼‰ã€ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹å„€å¼ã‚’è¡Œã„ã¾ã™ã€‚',
        'ã“ã®ãŸã‚ã«å¿…è¦ãªã®ãŒ**ã€ŒNode.jsï¼ˆãƒãƒ¼ãƒ‰ãƒ»ã‚¸ã‚§ã‚¤ã‚¨ã‚¹ï¼‰ã€**ã§ã™ã€‚',
        'é›£ã—ãè€ƒãˆãªãã¦å¤§ä¸ˆå¤«ã§ã™ã€‚',
        'å®Ÿã¯ã€ç§ãŸã¡ãŒä½¿ã£ã¦ã„ã‚‹**JavaScript**ã¯ã€ã‚‚ã¨ã‚‚ã¨',
        '**Webãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸­ã§å‹•ããŸã‚ã«ä½œã‚‰ã‚ŒãŸè¨€èª**ã§ã—ãŸã€‚',
        'ã¤ã¾ã‚Šä»¥å‰ã¯ã€',
        '- Chrome ã‚„ Safari ã®ä¸­ã§ã¯å‹•ã',
        '- ã§ã‚‚ PCãã®ã‚‚ã®ã‚’å‹•ã‹ã™ã“ã¨ã¯ã§ããªã„',
        'â€•ãã‚“ãªåˆ¶é™ãŒã‚ã£ãŸã‚“ã§ã™ã€‚',
        'ãã“ã§ç™»å ´ã—ãŸã®ãŒ**Node.jsï¼ˆãƒãƒ¼ãƒ‰ãƒ»ã‚¸ã‚§ã‚¤ã‚¨ã‚¹ï¼‰**ã§ã™ã€‚',
        '**JavaScript ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã®å¤–ï¼ˆPCã‚„ã‚µãƒ¼ãƒãƒ¼ä¸Šï¼‰ã§ã‚‚å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹å®Ÿè¡Œç’°å¢ƒã€‚**',
        'ã“ã‚Œã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ JavaScript ã¯ã€',
        '- Webã‚µã‚¤ãƒˆã®è¦‹ãŸç›®ã‚’å‹•ã‹ã™ã ã‘ã§ãªã',
        '- ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚„ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ãªã©',
        '- PCã‚„è£å´ã®å‡¦ç†ã‚‚æ‹…å½“ã§ãã‚‹',
        'ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚',
        'ã¤ã¾ã‚Š Node.js ã¯ã€',
        '**JavaScript ã®ã€Œæ´»å‹•ç¯„å›²ã€ã‚’ä¸€æ°—ã«åºƒã’ã‚‹ä»•çµ„ã¿**ã§ã™ã€‚',
        'ãã—ã¦ã€Node.js ã‚’å…¥ã‚Œã‚‹æœ€å¤§ã®ãƒ¡ãƒªãƒƒãƒˆãŒ',
        '**npmï¼ˆã‚¨ãƒŒãƒ”ãƒ¼ã‚¨ãƒ ï¼‰**ã¨ã„ã†ä»•çµ„ã¿ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ã€‚',
        'npm ã¨ã¯ã€',
        '- ä¸–ç•Œä¸­ã®é–‹ç™ºè€…ãŒä½œã£ãŸä¾¿åˆ©ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ éƒ¨å“ã‚’',
        '- ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºã§è¿½åŠ ã§ãã‚‹',
        '**JavaScriptå°‚ç”¨ã®éƒ¨å“å€‰åº«**ã§ã™ã€‚',
        'ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€é–‹ç™ºãƒ„ãƒ¼ãƒ«â€¦â€¦',
        'å¤šãã®ã‚‚ã®ã‚’**ã‚¼ãƒ­ã‹ã‚‰ä½œã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚**',
        'Node.js ã‚’å…¥ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã¯ã€**JavaScriptã§ã€Œã‚¢ãƒ—ãƒªé–‹ç™ºãŒã§ãã‚‹ç’°å¢ƒã€ã‚’æ‰‹ã«å…¥ã‚Œã‚‹**ã¨ã„ã†æ„å‘³ãªã‚“ã§ã™ã€‚',
        'ã“ã“ã‚‚ã€åŸºæœ¬ã¯ã™ã¹ã¦**AIã«ä»»ã›ã¦OK**ã§ã™ã€‚',
        'ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ã¯ã€ãŸã ä¸€ã¤ã€‚',
        '**Node.js ãŒå…¥ã‚Šã€é­”æ³•ï¼ˆnpm / é–‹ç™ºã‚³ãƒãƒ³ãƒ‰ï¼‰ãŒä½¿ãˆã‚‹çŠ¶æ…‹ã«ãªã‚‹ã“ã¨**',
        'ãã‚Œä»¥å¤–ã¯ã€ä»Šã“ã®ç¬é–“ã«å®Œç’§ã§ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚',
        'ã¾ãšã¯ã€ä»¥ä¸‹ã®å‘ªæ–‡ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’',
        'ãã®ã¾ã¾ãƒãƒ£ãƒƒãƒˆæ¬„ã«ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚' // ã“ã‚Œã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç›´å‰ãªã®ã§ã€ã“ã“ã¯é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã§OKã€ãã®æ¬¡ã‹ã‚‰ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‚
    ];

    const lines = content.split('\n');
    const newLines = lines.map(line => {
        // Check if the trimmed line (without >) constitutes match
        const cleanLine = line.replace(/^> /, '').replace(/^>/, '').trim();

        // å˜ç´”ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒã§ã¯ãªãã€ã‚‚ã£ã¨ç¢ºå®Ÿãªæ–¹æ³•ãŒå¿…è¦ã‹ã‚‚ã€‚
        // ãƒªã‚¹ãƒˆå†…ã®ã©ã‚Œã‹ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰ã€å¼•ç”¨ã‚’å¤–ã™ã€‚

        let shouldUnwrap = false;
        for (const phrase of targetPhrases) {
            // phraseãŒcleanLineã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ï¼ˆMarkdownè¨˜å·ãªã©ã‚’è€ƒæ…®ã—ã¦ç·©å’Œä¸€è‡´ã•ã›ãŸã„ãŒã€ã¨ã‚Šã‚ãˆãšexact matchã«è¿‘ã„å½¢ã§ï¼‰
            // phraseè‡ªä½“ã«MarkdownãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€å˜ç´”ãªincludesã§ã‚ˆã„ã¯ãš
            if (line.includes(phrase)) {
                shouldUnwrap = true;
                break;
            }
        }

        // èª¤çˆ†ã‚’é˜²ããŸã‚ã€æ˜ã‚‰ã‹ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå‘¨è¾ºã®è¡Œã ã‘ã‚’ç‹™ã„ãŸã„ã€‚
        // ç¬¬2ç« ã®ç‰¹å®šã®ç¯„å›²å†…ï¼ˆè¡Œç•ªå·570ä»˜è¿‘ã‹ã‚‰ï¼‰ã«ã‚ã‚‹ã¨ä»®å®šã€‚
        // ã—ã‹ã—è¡Œç•ªå·ã¯å¤‰ã‚ã‚‹ã€‚

        // åˆ¥ã®æ–¹æ³•: "### 3.3 Node.js ã®å½¹å‰²" ã‹ã‚‰æ¬¡ã® "###" ã¾ã§ã€ã‚ã‚‹ã„ã¯ç‰¹å®šã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé–‹å§‹ã¾ã§ã€‚
        // å®‰å…¨ã«ã€ãƒ•ãƒ¬ãƒ¼ã‚ºä¸€è‡´ã§è¡Œã†ã€‚

        if (shouldUnwrap && line.trim().startsWith('>')) {
            return line.replace(/^> ?/, '');
        }

        // ãƒªã‚¹ãƒˆé …ç›®ï¼ˆç®‡æ¡æ›¸ãï¼‰ã‚‚å¯¾å¿œ
        // "> - " ã¨ãªã£ã¦ã„ã‚‹ã‚‚ã®
        if ((cleanLine.startsWith('- ') || cleanLine.startsWith('* ')) && line.trim().startsWith('>')) {
            // ã“ã‚ŒãŒä¸Šè¨˜ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹ã‹åˆ¤æ–­ã™ã‚‹ã®ã¯é›£ã—ã„ã€‚
            // ã—ã‹ã—ã€Node.jsã®èª¬æ˜ç®‡æ‰€ã«ã‚ã‚‹ãƒªã‚¹ãƒˆã¯å…¨ã¦è§£é™¤å¯¾è±¡ã€‚
            if (line.includes('Chrome ã‚„ Safari') || line.includes('PCãã®ã‚‚ã®ã‚’') || line.includes('Webã‚µã‚¤ãƒˆã®è¦‹ãŸç›®') || line.includes('ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ') || line.includes('PCã‚„è£å´') || line.includes('ä¸–ç•Œä¸­ã®é–‹ç™ºè€…') || line.includes('ã‚³ãƒãƒ³ãƒ‰ä¸€ç™º')) {
                return line.replace(/^> ?/, '');
            }
        }

        return line;
    });

    // è¿½åŠ å‡¦ç†: ç”»åƒã‚‚ãƒ–ãƒ­ãƒƒã‚¯ã«å…¥ã£ã¦ã—ã¾ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
    // > ![](images/external_image_14.jpg)
    // ã“ã‚Œã‚‚å¤–ã™
    // æ–‡è„ˆçš„ã«ã€"3.3 Node.js ã®å½¹å‰²" ã®ç›´ä¸‹ã®ç”»åƒã€‚

    // æµã‚Œã§å‡¦ç†ã™ã‚‹:
    // "### 3.3 Node.js ã®å½¹å‰²" ã‚’è¦‹ã¤ã‘ãŸã‚‰ã€ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦ã€
    // "ã¾ãšã¯ã€ä»¥ä¸‹ã®å‘ªæ–‡ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’" ãŒå‡ºã‚‹ã¾ã§ã€å…¨ã¦ã® `> ` ã‚’å¤–ã™ã€ã¨ã„ã†ãƒ­ã‚¸ãƒƒã‚¯ã®æ–¹ãŒå®‰å…¨ã‹ã¤ç¢ºå®Ÿã€‚

    let isInsideTargetSection = false;
    const finalLines = [];

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        if (line.includes('### 3.3 Node.js ã®å½¹å‰²')) {
            isInsideTargetSection = true;
        }

        // çµ‚äº†æ¡ä»¶: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é–‹å§‹ã‚’ç¤ºå”†ã™ã‚‹è¡Œã€ã¾ãŸã¯æ¬¡ã®è¦‹å‡ºã—
        // "ã¾ãšã¯ã€ä»¥ä¸‹ã®å‘ªæ–‡ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’" ã®æ¬¡ã®è¡Œã‚ãŸã‚Šã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå§‹ã¾ã‚‹ã¯ãšã€‚
        // "ãã®ã¾ã¾ãƒãƒ£ãƒƒãƒˆæ¬„ã«ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚" ã®æ¬¡ã®è¡Œã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼Ÿ
        // ã„ã‚„ã€"ãã®ã¾ã¾ãƒãƒ£ãƒƒãƒˆæ¬„ã«ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚" è‡ªä½“ã¯èª¬æ˜æ–‡ãªã®ã§unwrapå¯¾è±¡ã€‚
        // ãã®æ¬¡ã®è¡Œï¼ˆæã‚‰ãç©ºè¡ŒæŒŸã‚“ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‹ã‚‰ã¯unwrapã—ãªã„ã€‚

        if (isInsideTargetSection) {
            if (line.startsWith('## ') || line.startsWith('# ')) {
                // æ¬¡ã®å¤§ããªè¦‹å‡ºã—ãŒæ¥ãŸã‚‰çµ‚äº†ï¼ˆåŸºæœ¬ãªã•ãã†ã ãŒï¼‰
                isInsideTargetSection = false;
            }

            // "ruby"ç”±æ¥ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ãŒå§‹ã¾ã‚‹ç›´å‰ã§æ­¢ã‚ãŸã„ã€‚
            // ã—ã‹ã—ã€ä»Šã® content ã¯æ—¢ã« ruby ãŒæ¶ˆãˆã¦ `> ` ã«ãªã£ã¦ã„ã‚‹ã€‚
            // ç‰¹å¾´çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ–‡ç« ã§æ­¢ã‚ã‚‹ã€‚
            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ¬æ–‡: "ã‚ãªãŸã¯ã€çµŒé¨“è±Šå¯Œãªã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™..." ã¨ã‹ï¼Ÿ
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ç”»åƒã«ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¸­èº«ãŒãªã„ãŒã€3æšç›®ã®ç”»åƒã®ä¸‹éƒ¨ã«
            // "ã¾ãšã¯ã€ä»¥ä¸‹ã®å‘ªæ–‡...ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚" ãŒã‚ã‚‹ã€‚
            // ãã®ä¸‹ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã¯ãšã€‚

            // å®‰å…¨ç­–: "ãã®ã¾ã¾ãƒãƒ£ãƒƒãƒˆæ¬„ã«ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚" ã®è¡Œã¾ã§ã‚’ã‚¢ãƒ³ãƒ©ãƒƒãƒ—ã—ã¦ã€ãƒ•ãƒ©ã‚°ã‚’ä¸‹ã‚ã™ã€‚
            if (line.includes('ãã®ã¾ã¾ãƒãƒ£ãƒƒãƒˆæ¬„ã«ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚')) {
                if (line.trim().startsWith('>')) {
                    line = line.replace(/^> ?/, '');
                }
                isInsideTargetSection = false;
            } else if (line.trim().startsWith('>')) {
                // è¦‹å‡ºã—ä»¥å¤–ã® > ã‚’å¤–ã™
                // å¼•ç”¨å†…ã®ç©ºè¡Œ ">" ã‚‚ "" ã«ã™ã‚‹
                line = line.replace(/^> ?/, '');
                // ã‚‚ã— ">" ã ã‘ã ã£ãŸè¡Œã¯ç©ºè¡Œã«ãªã‚‹
            }
        }

        finalLines.push(line);
    }

    await fs.writeFile(TARGET_FILE, finalLines.join('\n'), 'utf8');
    console.log('âœ… èª¤ã£ã¦å¼•ç”¨ã«ãªã£ã¦ã„ãŸè§£èª¬æ–‡ã‚’é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã«æˆ»ã—ã¾ã—ãŸ');
}

unwrapFalsePrompts().catch(console.error);
