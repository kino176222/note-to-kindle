const fs = require('fs-extra');

async function fixRiskPrompt() {
    console.log('ğŸ§¹ ãƒªã‚¹ã‚¯æ¤œè¨¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¼•ç”¨ãƒ–ãƒ­ãƒƒã‚¯ã«çµ±åˆã—ã¾ã™...');

    const TARGET_FILE = '/Users/kino/Desktop/vibe_coding_master.md';
    let content = await fs.readFile(TARGET_FILE, 'utf8');

    // ç¾çŠ¶:
    // > \nã“ã®Webã‚¢ãƒ—ãƒªã‚’...
    // 
    // ã¾ãšã€... (ã“ã“ã‹ã‚‰å¼•ç”¨ãƒ–ãƒ­ãƒƒã‚¯åˆ‡ã‚Œã¦ã‚‹å¯èƒ½æ€§ã‚ã‚Š)

    // æˆ¦ç•¥: 
    // æ¤œç´¢èª: "ã“ã®Webã‚¢ãƒ—ãƒªã‚’ã€å€‹äººé–‹ç™ºã¨ã—ã¦å…¨ä¸–ç•Œã«å…¬é–‹ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚"
    // çµ‚äº†èª: "ãŒã‚ã‚Œã°ã€ç†ç”±ã¨ã‚ã‚ã›ã¦ææ¡ˆã—ã¦ãã ã•ã„ã€‚"

    // ã“ã®ç¯„å›²ã‚’ä¸€æ‹¬ã—ã¦æ•´å½¢ã•ã‚ŒãŸå¼•ç”¨ãƒ–ãƒ­ãƒƒã‚¯ã«ã™ã‚‹ã€‚

    const startStr = "ã“ã®Webã‚¢ãƒ—ãƒªã‚’ã€å€‹äººé–‹ç™ºã¨ã—ã¦å…¨ä¸–ç•Œã«å…¬é–‹ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚";
    const endStr = "ãŒã‚ã‚Œã°ã€ç†ç”±ã¨ã‚ã‚ã›ã¦ææ¡ˆã—ã¦ãã ã•ã„ã€‚";

    const startIndex = content.indexOf(startStr);
    const endIndex = content.indexOf(endStr);

    if (startIndex !== -1 && endIndex !== -1) {
        // å…ˆé ­ã®å¼•ç”¨è¨˜å·ã‚’é™¤å»ã—ã¦å–ã‚Šè¾¼ã‚€ãŸã‚ã€å°‘ã—å‰ã‹ã‚‰æ¢ã™ã®ã‚‚æ‰‹ã ãŒã€
        // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¦‹ã‚‹ã¨ã€Œ> \nã“ã®...ã€ã¨ãªã£ã¦ã„ã‚‹ã€‚

        const originalBlock = content.substring(startIndex, endIndex + endStr.length);

        // æ–°ã—ã„ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆï¼ˆå…¨è¡Œã« > ã‚’ã¤ã‘ã‚‹ï¼‰
        const newBlock = `> ã“ã®Webã‚¢ãƒ—ãƒªã‚’ã€å€‹äººé–‹ç™ºã¨ã—ã¦å…¨ä¸–ç•Œã«å…¬é–‹ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚
> 
> ã¾ãšã€
> - ã“ã®ã‚¢ãƒ—ãƒªã«è€ƒãˆã‚‰ã‚Œã‚‹ãƒªã‚¹ã‚¯ã‚’æ´—ã„å‡ºã—ã€
> - å…¬é–‹å‰ã«æœ€ä½é™æ°—ã‚’ã¤ã‘ã‚‹ã¹ããƒã‚¤ãƒ³ãƒˆã‚’
>   åˆå¿ƒè€…ã«ã‚‚åˆ†ã‹ã‚‹è¨€è‘‰ã§ã€ç®‡æ¡æ›¸ãã§æ•´ç†ã—ã¦ãã ã•ã„ã€‚
> 
> ã€å‰æã€‘
> - å€‹äººã®å­¦ç¿’ãƒ»è¶£å‘³é–‹ç™ºã§ã™
> - ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“
> - å€‹äººæƒ…å ±ï¼ˆåå‰ãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç­‰ï¼‰ã¯æ‰±ã„ã¾ã›ã‚“
> - åç›ŠåŒ–ã‚„åºƒå‘Šã¯ã‚ã‚Šã¾ã›ã‚“
> - æ—¥æœ¬å‘ã‘ã§ã™ãŒã€æµ·å¤–ã‹ã‚‰ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™
> 
> ãã®ã†ãˆã§ã€
> - æœ€ä½é™ç”¨æ„ã—ãŸæ–¹ãŒã‚ˆã„ã€Œåˆ©ç”¨è¦ç´„ã€
> - æœ€ä½é™ç”¨æ„ã—ãŸæ–¹ãŒã‚ˆã„ã€Œãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã€
>   ãŒã‚ã‚Œã°ã€ç†ç”±ã¨ã‚ã‚ã›ã¦ææ¡ˆã—ã¦ãã ã•ã„ã€‚`;

        // å‰å¾Œã®æ•´é “
        // æ—¢å­˜ã® "> " ã¨ã‹ã‚’å–ã‚Šé™¤ããŸã‚ã€ç½®æ›ç¯„å›²ã‚’åºƒã’ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ãŒã€
        // å˜ç´”ç½®æ›ã§è©¦ã™ã€‚å…ƒã€…å¼•ç”¨ã«å…¥ã£ã¦ã„ãŸæœ€åˆã®è¡Œã‚‚å«ã‚“ã§ã„ã‚‹ã®ã§ã€‚
        // ãŸã ã—ã€å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã®æ”¹è¡Œã¨ã‹ã‚¹ãƒšãƒ¼ã‚¹ãŒå¾®å¦™ã«é•ã†ã¨ãƒãƒƒãƒã—ãªã„ã€‚
        // ç¢ºå®Ÿãªã®ã¯ã€startIndexã‹ã‚‰endIndexã¾ã§ã‚’ã‚¬ãƒã£ã¨ç½®æ›ã€‚

        // å¿µã®ãŸã‚ã€ç½®æ›å‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç›®è¦–ç¢ºèªã—ã¦ã„ãªã„éƒ¨åˆ†ã‚‚å«ã‚€ã®ã§ã€
        // æ…é‡ã«ã€‚

        // ç¾åœ¨ã®æ§‹æˆ:
        // **ã€ã‚³ãƒ”ãƒšç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆãƒªã‚¹ã‚¯æ¤œè¨¼ & ä½œæˆï¼‰ã€‘**
        // 
        // > \nã“ã®Webã‚¢ãƒ—ãƒªã‚’...
        // 
        // ã¾ãšã€... (ã“ã“ã¯å¼•ç”¨å¤–ã‚Œã¦ã‚‹ï¼Ÿ)

        // ã‚¹ãƒ†ãƒƒãƒ—1: ã¾ãšç¯„å›²å…¨ä½“ã‚’å–å¾—ã—ã¦ã€å¼•ç”¨è¨˜å·ãªã—ã®çŠ¶æ…‹ã«ã™ã‚‹
        let rawText = content.substring(startIndex, endIndex + endStr.length);

        // æ—¢å­˜ã®æ”¹è¡Œãªã©ãŒã©ã†ãªã£ã¦ã„ã‚‹ã‹ä¸æ˜ã ãŒã€
        // ã¨ã‚Šã‚ãˆãšæ–°ã—ã„ãƒ–ãƒ­ãƒƒã‚¯ã«å·®ã—æ›¿ãˆã¦ã¿ã‚‹ã€‚

        const before = content.substring(0, startIndex);
        const after = content.substring(endIndex + endStr.length);

        // beforeã®æœ«å°¾ã«ã‚ã‚‹ `> \n` ãªã©ã‚’æƒé™¤
        // grepã§è¦‹ã‚‹ã¨ `1645:ã“ã®Web...` ãªã®ã§ã€ãã®å‰ã®è¡Œã« `> ` ãŒã‚ã‚‹ã¯ãšï¼Ÿ 
        // grep output shows: `> \nã“ã®Web...` 

        // 1640ã€œã‚’è¦‹ã‚‹é™ã‚Šã€
        // > 
        // ã“ã®Webã‚¢ãƒ—ãƒªã‚’...

        // ã¨ãªã£ã¦ã„ã‚‹ã®ã§ã€ `> ` ã®è¡ŒãŒä¸€ã¤å‰ã«ã‚ã‚‹ã€‚
        // ãã‚Œã‚’å«ã‚ã¦ç½®æ›ã—ãŸã„ã€‚

        const lastQuoteIndex = before.lastIndexOf('>');
        let efficientBefore = before;
        if (lastQuoteIndex !== -1 && lastQuoteIndex > before.length - 10) {
            // ç›´å‰ã«å¼•ç”¨è¨˜å·ãŒã‚ã‚Œã°ã€ãã“ã‹ã‚‰ç½®æ›é–‹å§‹ã«ã™ã‚‹
            efficientBefore = before.substring(0, lastQuoteIndex);
        }

        content = efficientBefore + newBlock + after;

        console.log('âœ… ãƒªã‚¹ã‚¯æ¤œè¨¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¼•ç”¨ãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦çµ±åˆã—ã¾ã—ãŸ');

    } else {
        console.error('Target prompt text not found');
    }

    await fs.writeFile(TARGET_FILE, content, 'utf8');
}

fixRiskPrompt().catch(console.error);
