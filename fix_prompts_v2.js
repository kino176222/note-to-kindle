const fs = require('fs-extra');

async function fixAiRulesAndPrompts() {
    console.log('ğŸ‘· AI Rulesã®è¦‹ãŸç›®è£œæ­£ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåŒ–æ¼ã‚Œã‚’ä¿®æ­£ã—ã¾ã™...');

    const TARGET_FILE = '/Users/kino/Desktop/vibe_coding_master.md';
    let content = await fs.readFile(TARGET_FILE, 'utf8');

    // 1. AI Rulesã®å†æ•´å½¢
    // ã¾ãšã€ä¸€æ—¦å…¨ã¦ã® > ã‚’è§£é™¤ã—ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ã«æˆ»ã™ï¼ˆAI Ruleséƒ¨åˆ†ã®ã¿ï¼‰
    const rulesRegex = /(\*\*AI Rules[\s\S]*?;yb)/;
    const match = content.match(rulesRegex);

    if (match) {
        let rawRules = match[1].replace(/^> ?/gm, ''); // å¼•ç”¨è§£é™¤

        // æ”¹è¡Œã‚’ç¶­æŒã—ã¤ã¤ã€å…¨è¡Œã« > ã‚’ã¤ã‘ã‚‹
        // ãŸã ã—ã€ãƒªã‚¹ãƒˆé …ç›®ãªã©ã®å‰ã«ã¯ç©ºè¡Œå¼•ç”¨ `>` ã‚’å…¥ã‚Œã¦ã€è¦‹ãŸç›®ã®éš™é–“ã‚’ä½œã‚‹

        const lines = rawRules.split('\n');
        const processedLines = lines.map((line, index) => {
            const trimmed = line.trim();
            if (trimmed === '') return '>\n>'; // ç©ºè¡Œã¯å¼·èª¿

            // ãƒªã‚¹ãƒˆã®é–‹å§‹ã‚„ã€ç‰¹å®šã®åŒºåˆ‡ã‚Šã®å‰ã«ã¯ç©ºè¡Œã‚’å…¥ã‚ŒãŸã„
            // ã—ã‹ã—ã€ä¸‹æ‰‹ã«ã„ã˜ã‚‹ã¨å´©ã‚Œã‚‹ã®ã§ã€åŸºæœ¬ã¯ç´ ç›´ã«å…¨è¡Œå¼•ç”¨ã«ã™ã‚‹ã€‚
            // å‰å›ã®å´©ã‚Œã®åŸå› ã¯ã€Œè©°ã‚è¾¼ã¿ã™ãã€ã‹ã€Œæ”¹è¡Œã‚³ãƒ¼ãƒ‰ã®æ‰±ã„ã€

            // ä»Šå›ã¯å˜ç´”ã« `> Line` ã«å¤‰æ›ã™ã‚‹ã€‚
            // Markdownã¨ã—ã¦ã€
            // > Line 1
            // >
            // > Line 2
            // ã¨ãªã£ã¦ã„ã‚Œã°ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚‚é›¢ã‚Œã‚‹ã¯ãšã€‚
            return `> ${line}`;
        });

        content = content.replace(rulesRegex, processedLines.join('\n'));
    }

    // 2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåŒ–æ¼ã‚Œï¼ˆruby ...ï¼‰ã®ä¿®æ­£
    // ãƒ‘ã‚¿ãƒ¼ãƒ³: ### ã€ã‚³ãƒ”ãƒšç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‘\n\n ruby .....
    // ã‚ã‚‹ã„ã¯å˜ã« ruby .....

    // ã¾ãš ruby ã¨ã„ã†å˜èªã‚’æ¶ˆã—ã¤ã¤ã€ãã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’å¼•ç”¨åŒ–
    // ãƒ–ãƒ­ãƒƒã‚¯ã®çµ‚ã‚ã‚Šã¯ã€ç©ºè¡ŒãŒ2ã¤ç¶šãã‹ã€æ¬¡ã®è¦‹å‡ºã—ã¾ã§

    // æ±ç”¨çš„ãªç½®æ›: æ–‡é ­ã® ruby ã‚’å‰Šé™¤ã—ã€ãã®æ®µè½ã‚’å¼•ç”¨ã«ã™ã‚‹
    // "ruby ã‚µãƒ¼ãƒãƒ¼ã‚’..." -> "> ã‚µãƒ¼ãƒãƒ¼ã‚’..."

    // æ­£è¦è¡¨ç¾ã§ã€"ruby " ã§å§‹ã¾ã‚‹è¡Œã‹ã‚‰ã€æ”¹è¡ŒãŒé€£ç¶šã™ã‚‹ã¾ã§ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
    content = content.replace(/^ruby ([\s\S]*?)(?=\n\n|\n#)/gm, (match, body) => {
        // bodyã®å„è¡Œã« > ã‚’ã¤ã‘ã‚‹
        return body.split('\n').map(l => `> ${l}`).join('\n');
    });

    // ã¾ã  ruby ãŒæ®‹ã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆç­‰ã§ï¼‰
    content = content.replace(/ruby /g, ''); // å¿µã®ãŸã‚å‰Šé™¤

    // 3. ã€ã‚³ãƒ”ãƒšç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‘ã®ä¸‹ãŒå¼•ç”¨ã«ãªã£ã¦ã„ãªã„ã‚±ãƒ¼ã‚¹ã‚’æ•‘æ¸ˆ
    // ã‚‚ã—ä¸Šè¨˜ã§æ‹¾ãˆãªã‹ã£ãŸå ´åˆï¼ˆrubyãŒã¤ã„ã¦ãªã‹ã£ãŸã¨ã‹ï¼‰
    // ### ã€ã‚³ãƒ”ãƒšç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‘\n\nãƒ†ã‚­ã‚¹ãƒˆ...
    // ã“ã‚Œã‚’
    // ### ã€ã‚³ãƒ”ãƒšç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‘\n\n> ãƒ†ã‚­ã‚¹ãƒˆ...
    // ã«ã—ãŸã„ãŒã€èª¤çˆ†ãŒæ€–ã„ã®ã§ã€ç‰¹å®šã®ãƒ•ãƒ¬ãƒ¼ã‚ºã§ç‹™ã„æ’ƒã¡

    const promptPhrases = [
        'ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¦',
        'ä»Šã‹ã‚‰ GitHub ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã‚’ã—ã¾ã™'
    ];

    promptPhrases.forEach(phrase => {
        // æ—¢ã«å¼•ç”¨ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
        if (content.indexOf(`> ${phrase}`) === -1) {
            // ãªã£ã¦ã„ãªã‘ã‚Œã°ç½®æ›
            content = content.replace(phrase, `> ${phrase}`);
            // è¤‡æ•°è¡Œã«ã‚ãŸã‚‹å ´åˆã€å¾Œç¶šã®è¡Œã‚‚å¼•ç”¨ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€
            // ä¸Šè¨˜ã® ruby ç½®æ›ã§å¤§ä½“ã‚«ãƒãƒ¼ã§ãã¦ã„ã‚‹ã¯ãšã€‚
            // å¿µã®ãŸã‚ã€ãã®è¡Œã‹ã‚‰ç©ºè¡Œã¾ã§ã‚’ç½®æ›ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
            const regex = new RegExp(`^${phrase}[\\s\\S]*?(?=\\n\\n)`, 'm');
            content = content.replace(regex, (m) => m.split('\n').map(l => `> ${l}`).join('\n'));
        }
    });

    await fs.writeFile(TARGET_FILE, content, 'utf8');
    console.log('âœ… AI Rulesã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿®æ­£å®Œäº†');
}

fixAiRulesAndPrompts().catch(console.error);
