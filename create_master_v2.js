
const fs = require('fs-extra');
const path = require('path');

// å…¥åŠ›å…ƒï¼ˆNoteã®Markdownï¼‰
const notePath = '/Users/kino/Library/Mobile Documents/iCloud~md~obsidian/Documents/Mynote/10_Inbox/WebClip/ã€å®Œå…¨ç„¡æ–™ã€‘åˆå¿ƒè€…å‘ã‘Vibe Codingå…¥é–€ï¼šAIã¨å¯¾è©±ã—ã¦ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹â†’Gitã§ä¿å­˜â†’ä¸–ç•Œã«å…¬é–‹ï½œKino.md';
// å‡ºåŠ›å…ˆï¼ˆãƒã‚¹ã‚¿ãƒ¼åŸç¨¿ï¼‰
const outputPath = '/Users/kino/Desktop/vibe_coding_master.md';

async function createMasterManuscript() {
    console.log('Reading pristine source...');
    let content = await fs.readFile(notePath, 'utf8');

    // ---------------------------------------------------------
    // 1. ä¸è¦ãªéƒ¨åˆ†ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã€åºƒå‘Šï¼‰ã®å‰Šé™¤
    // ---------------------------------------------------------
    // Frontmatterå‰Šé™¤
    content = content.replace(/^---[\s\S]*?---\n*/, '');

    // Noteåºƒå‘ŠãƒãƒŠãƒ¼ãªã©ã®å‰Šé™¤ (ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ç”»åƒè¡Œ)
    content = content.replace(/^!\[.*?(banner|campaign|point).*?\]\(.*?\)\n*/gmi, '');
    // æ–‡æœ«ã®Noteã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç”»åƒã®å‰Šé™¤ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¾å­˜ï¼‰
    content = content.replace(/!\[.*?\]\(https:\/\/assets\.st-note\.com\/.*?campaign.*?\)/g, '');

    // ---------------------------------------------------------
    // 2. ã€Œã¯ã˜ã‚ã«ã€ã®æ–‡è¨€å¾©æ´» & ç« æ§‹æˆã®ãƒªã‚»ãƒƒãƒˆ
    // ---------------------------------------------------------
    // å‰å›ã¯ã€Œã“ã‚“ã«ã¡ã¯ã€ä»¥é™ã‚’æ¶ˆã—ã¦ã—ã¾ã£ãŸãŒã€ä»Šå›ã¯ã€ŒæŒ¨æ‹¶ã€ã¯æ®‹ã™ã‹ã€
    // ã‚ã‚‹ã„ã¯ã€Œã¯ã˜ã‚ã«ã€ã®è¦‹å‡ºã—ã‚’ã¤ã‘ã‚‹ã€‚
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œã•ã£ãã¾ã§ã‚ã£ãŸæ–‡è¨€ã€ã¨è¨€ã£ã¦ã„ã‚‹ãŸã‚ã€Noteã®åŸæ–‡ã‚’æ¥µåŠ›ç¶­æŒã™ã‚‹ã€‚

    // ãŸã ã—ã€Noteã®ç›®æ¬¡ç”¨ãƒªãƒ³ã‚¯ãªã©ã¯å‰Šé™¤ã—ãŸã„
    content = content.replace(/\[(toc|ç›®æ¬¡)\]/gi, '');

    // æ‰‹å‹•ã®ç« ç•ªå·ï¼ˆ0ç« ã€1ç« ...ï¼‰ã¯å‰Šé™¤ã—ã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãªè¦‹å‡ºã—ã«ã™ã‚‹
    content = content.replace(/^##\s*\d+ç« [ï¼š:\s]*/gm, '## '); // "## 0ç« ï¼š" -> "## "
    content = content.replace(/^##\s*ç¬¬\d+ç« [ï¼š:\s]*/gm, '## ');
    content = content.replace(/^###\s*\d+(\.\d+)?[ï¼š:\s]*/gm, '### ');

    // ---------------------------------------------------------
    // 3. ãƒ†ã‚­ã‚¹ãƒˆç½®æ›
    // ---------------------------------------------------------
    // Note -> æœ¬æ›¸
    content = content.replace(/Note/g, 'æœ¬æ›¸'); // "Note" -> "æœ¬æ›¸" (è‹±èªã®Noteã¯é™¤å¤–ã™ã¹ãã‹ï¼Ÿæ–‡è„ˆã«ã‚ˆã‚‹ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤ºå„ªå…ˆ)
    // ãŸã ã— "Note-to-Kindle" ãªã©ã®ã‚³ãƒ¼ãƒ‰ã‚„URLã«å«ã¾ã‚Œã‚‹ "Note" ã¯å¤‰ãˆãŸããªã„ã€‚
    // å˜èªã®å¢ƒç•Œã‚’æ„è­˜ã™ã‚‹ã‹ã€å…¨ç½®æ›ã—ã¦å¾Œã§æˆ»ã™ã‹ã€‚
    // ç°¡æ˜“çš„ã«å…¨ç½®æ›ã™ã‚‹ãŒã€URLå†…ã® `assets.st-note.com` ç­‰ãŒå£Šã‚Œã‚‹ã¨ãƒã‚ºã‚¤ã€‚
    // -> URLä»¥å¤–ã®å ´æ‰€ã¦ç½®æ›ã™ã‚‹ã®ã¯RegExãŒè¤‡é›‘ã€‚
    // å¦¥å”æ¡ˆ: ã€Œã“ã®è¨˜äº‹ã€ã€Œã“ã®Noteã€ãªã©ã®è¡¨ç¾ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹ã€‚
    content = content.replace(/ã“ã®Note/g, 'æœ¬æ›¸');
    content = content.replace(/Noteè¨˜äº‹/g, 'æœ¬æ›¸');
    content = content.replace(/Note/g, (match, offset, str) => {
        // å‰å¾ŒãŒè‹±å­—ãªã‚‰ç½®æ›ã—ãªã„ï¼ˆURLã®ä¸€éƒ¨ç­‰ã®å¯èƒ½æ€§ï¼‰
        const before = str[offset - 1] || '';
        const after = str[offset + match.length] || '';
        if (/[a-zA-Z\/\-\.]/.test(before) || /[a-zA-Z\/\-\.]/.test(after)) {
            return match;
        }
        return 'æœ¬æ›¸';
    });

    // ---------------------------------------------------------
    // 4. Markdownã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
    // ---------------------------------------------------------
    // ãƒªã‚¹ãƒˆã®è¨˜å·çµ±ä¸€ (ãƒ» -> -)
    content = content.replace(/^ãƒ»/gm, '-');
    // ãƒªã‚¹ãƒˆã®å‰ã®ç©ºè¡Œç¢ºä¿
    content = content.replace(/([^\n])\n(- |ãƒ»|âœ…|ğŸ”²)/g, '$1\n\n$2');

    // åŒºåˆ‡ã‚Šç·š (---, ***) ã®å‰Šé™¤
    content = content.replace(/^\s*[-*_]{3,}\s*$/gm, '');

    // ---------------------------------------------------------
    // 5. ä¿å­˜
    // ---------------------------------------------------------
    // ä½™è¨ˆãªç©ºè¡Œã‚’è©°ã‚ã‚‹
    content = content.replace(/\n{3,}/g, '\n\n');

    await fs.writeFile(outputPath, content, 'utf8');
    console.log('Master manuscript created at:', outputPath);
}

createMasterManuscript().catch(console.error);
