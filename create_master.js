
const fs = require('fs-extra');
const path = require('path');

// å…¥åŠ›å…ƒï¼ˆNoteã®Markdownï¼‰
const notePath = '/Users/kino/Library/Mobile Documents/iCloud~md~obsidian/Documents/Mynote/10_Inbox/WebClip/ã€å®Œå…¨ç„¡æ–™ã€‘åˆå¿ƒè€…å‘ã‘Vibe Codingå…¥é–€ï¼šAIã¨å¯¾è©±ã—ã¦ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹â†’Gitã§ä¿å­˜â†’ä¸–ç•Œã«å…¬é–‹ï½œKino.md';
// å‡ºåŠ›å…ˆï¼ˆã‚¯ãƒªãƒ¼ãƒ³ãªMarkdownï¼‰
const outputPath = '/Users/kino/Desktop/vibe_coding_master.md';

async function createMasterManuscript() {
    console.log('Reading pristine source...');
    let content = await fs.readFile(notePath, 'utf8');

    // ---------------------------------------------------------
    // 1. ä¸è¦ãªéƒ¨åˆ†ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã€æŒ¨æ‹¶ãªã©ï¼‰ã®å‰Šé™¤
    // ---------------------------------------------------------

    // Frontmatterå‰Šé™¤
    content = content.replace(/^---[\s\S]*?---\n*/, '');

    // å†’é ­ã®ä¸è¦ãªãƒªãƒ³ã‚¯ã‚„ç”»åƒã®å‰Šé™¤ï¼ˆNoteç‰¹æœ‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒãªã©ï¼‰
    // ã‚¿ã‚¤ãƒˆãƒ«ã®å‰ã®ç”»åƒãƒ–ãƒ­ãƒƒã‚¯ãªã©ã‚’æ¶ˆã™
    content = content.replace(/^!\[.*?\]\(.*?\)\n*/m, '');

    // æœ€åˆã®è¡Œã«ã‚ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ç­‰ã‚‚èª¿æ•´
    // æ–‡é ­ã®ã€Œã“ã‚“ã«ã¡ã¯ã€‚Kinoã§ã™ã€‚ã€ã¾ã§ã‚’å‰Šé™¤ã—ã¦ã€ã‚¤ãƒ³ãƒˆãƒ­ã‹ã‚‰å§‹ã‚ã‚‹
    // "ã“ã‚“ã«ã¡ã¯ã€‚Kinoã§ã™ã€‚" ã‚’å«ã‚€æ®µè½ã¾ã§å‰Šé™¤
    const introStart = content.indexOf('ã“ã‚“ã«ã¡ã¯ã€‚Kinoã§ã™ã€‚');
    if (introStart !== -1) {
        // ãã“ã‹ã‚‰å°‘ã—ä¸‹ã®ã€Œ## ã¯ã˜ã‚ã«ã€ã®æ‰‹å‰ã¾ã§æ¶ˆã—ãŸã„ãŒã€
        // å˜ç´”ã«ã€Œã“ã‚“ã«ã¡ã¯...ã€ã®è¡Œã‚’å‰Šé™¤ã™ã‚‹
        // å®Ÿéš›ã¯ã€Œã“ã‚“ã«ã¡ã¯...ã€ã®å‰ã«ã‚ã‚‹å‰ç½®ãã‚‚æ¶ˆã—ãŸã„
        // ã€Œ## ã€ã§å§‹ã¾ã‚‹æœ€åˆã®ç« ï¼ˆã¯ã˜ã‚ã«ï¼‰ã‚ˆã‚Šå‰ã‚’ã™ã¹ã¦ã‚«ãƒƒãƒˆã—ã¦ã€ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã¤ã‘ç›´ã™ã®ãŒæœ€ã‚‚å®‰å…¨ã€‚
        const firstHeaderIndex = content.indexOf('## ');
        if (firstHeaderIndex !== -1) {
            let body = content.substring(firstHeaderIndex);
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä»˜ä¸
            content = '# Vibe Codingå…¥é–€ï¼šAIã¨å¯¾è©±ã—ã¦ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹\n\n' + body;
        }
    }

    // ---------------------------------------------------------
    // 2. ç« æ§‹æˆã®æ•´ç†ï¼ˆOutline Logicï¼‰
    // ---------------------------------------------------------
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ°—ã«å…¥ã£ã¦ã„ã‚‹æ§‹æˆï¼š
    // ç¬¬1ç«  = 0ç« ï¼ˆã‚´ãƒ¼ãƒ«ï¼‰
    // ç¬¬2ç«  = 1ç« ï¼ˆæº–å‚™ï¼‰...

    // å…ƒã®è¡¨è¨˜ã€Œ## 0ç« ã€ã€Œ## 1ç« ã€ãªã©ã‚’ã€Œ## ç¬¬1ç« ã€ã€Œ## ç¬¬2ç« ã€ã«å¤‰æ›ã™ã‚‹ã®ã§ã¯ãªãã€
    // ã“ã“ã¯ã€Œ## ã‚¿ã‚¤ãƒˆãƒ«ã€ã¨ã„ã†ç´”ç²‹ãªå½¢ã«æˆ»ã™ã®ãŒãƒ™ã‚¹ãƒˆï¼ˆKindleå´ã§é€£ç•ªã‚’æŒ¯ã‚‹ãŸã‚ï¼‰ã€‚
    // ã‚‚ã—ãã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›é€šã‚Šã€Œç¬¬â—‹ç« ã€ã¨ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã€‚
    // ä»Šå›ã¯ã€Œé€£ç•ªé‡è¤‡ãƒã‚°ã€ã‚’é˜²ããŸã‚ã€**ç•ªå·ã‚’å®Œå…¨ã«æ¶ˆã™**ã€‚
    // HTMLåŒ–ã®æ®µéšã§CSSã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§ç•ªå·ã‚’ã¤ã‘ã‚‹ã®ãŒä¸€ç•ªHTMLçš„ã§ç¶ºéº—ã ãŒã€
    // Markdownã¨ã—ã¦èª­ã¿ã‚„ã™ãã™ã‚‹ãŸã‚ã€ã‚ãˆã¦ç•ªå·ã¯ã€Œãªã—ã€ã«ã™ã‚‹ã€‚

    content = content.replace(/^##\s*\d+ç« [ï¼š:\s]*/gm, '## '); // "## 0ç« ï¼š" -> "## "
    content = content.replace(/^##\s*ç¬¬\d+ç« [ï¼š:\s]*/gm, '## ');
    content = content.replace(/^###\s*\d+(\.\d+)?[ï¼š:\s]*/gm, '### '); // "### 1.1" -> "### "

    // ---------------------------------------------------------
    // 3. æœ€ä½é™ã®Markdownã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
    // ---------------------------------------------------------

    // ãƒªã‚¹ãƒˆã®è¨˜å·çµ±ä¸€ (ãƒ» -> -)
    content = content.replace(/^ãƒ»/gm, '-');

    // ãƒªã‚¹ãƒˆã®å‰ã®ç©ºè¡Œç¢ºä¿ï¼ˆMarkdownä»•æ§˜ï¼‰
    content = content.replace(/([^\n])\n(- |ãƒ»|âœ…|ğŸ”²)/g, '$1\n\n$2');

    // ç”»åƒè¨˜æ³•ã®æ•´ç†ï¼ˆNoteã®ç”»åƒãƒªãƒ³ã‚¯ãªã©ã‚’æ¨™æº–åŒ–ï¼‰
    // Note: <figure>ã‚¿ã‚°ãªã©ãŒæ··ã˜ã£ã¦ã„ã‚‹å ´åˆã¯Markdownã«ç›´ã™
    content = content.replace(/<figure>[\s\S]*?<img src="(.*?)"[\s\S]*?<\/figure>/g, '![]($1)');

    // ---------------------------------------------------------
    // 4. ç¦æ­¢äº‹é …ï¼šHTMLã‚¿ã‚°åŸ‹ã‚è¾¼ã¿ã‚’ã—ãªã„
    // ---------------------------------------------------------
    // ã“ã“ã§ã¯ <div> ãªã©ã®ã‚¿ã‚°ã‚’ä¸€åˆ‡å…¥ã‚Œãªã„ã€‚
    // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãªã©ã¯ãã®ã¾ã¾ "- âœ… ãƒ†ã‚­ã‚¹ãƒˆ" ã¨ã—ã¦æ®‹ã™ã€‚

    // ---------------------------------------------------------
    // 5. ä¿å­˜
    // ---------------------------------------------------------

    // ä½™è¨ˆãªç©ºè¡Œã‚’è©°ã‚ã‚‹
    content = content.replace(/\n{3,}/g, '\n\n');

    await fs.writeFile(outputPath, content, 'utf8');
    console.log('Master manuscript created at:', outputPath);
}

createMasterManuscript().catch(console.error);
