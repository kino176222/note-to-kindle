const fs = require('fs-extra');
const path = require('path');

const INPUT_FILE = 'processed_manuscript.md';
const OUTPUT_FILE = 'kindle_draft.md';

async function refine() {
    let content = await fs.readFile(INPUT_FILE, 'utf8');

    // 1. ä¸è¦ãªã‚¿ã‚°ãƒ»è¡Œã®å‰Šé™¤
    content = content.replace(/<div style="page-break-before: always;"><\/div>/g, ''); // ä¸€æ—¦æ”¹ãƒšãƒ¼ã‚¸å‰Šé™¤ï¼ˆHTMLç”Ÿæˆæ™‚ã«åˆ¶å¾¡ã™ã‚‹ãŸã‚ï¼‰
    content = content.replace(/ğŸ”´.*?(\n|$)/g, ''); // èµ¤ä¸¸ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤
    content = content.replace(/;yb/g, '');
    content = content.replace(/g# AI Rules/g, '# AI Rules');

    // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒãƒŠãƒ¼å‰Šé™¤ (image_068)
    content = content.replace(/\[!\[è²·ã†ãŸã³.*?\]\(images\/image_068\.jpg\)\].*?\n/s, '');
    // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°å‰Šé™¤
    content = content.replace(/- \[\s*#ç„¡æ–™\s*\]\(.*?\)\n/g, '');
    content = content.replace(/- \[\s*#ãƒã‚¤ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°\s*\]\(.*?\)\n/g, '');

    // 2. QAã®å¤ªå­—è§£é™¤ & è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«ä¸‹ã’ï¼ˆç›®æ¬¡ã«å‡ºã•ãªã„ãŸã‚ï¼‰
    // ### Q1. ... -> **Q1. ...**
    // æ—¢å­˜ã®å¤ªå­—è§£é™¤ãƒ­ã‚¸ãƒƒã‚¯ã¨çµ±åˆ
    content = content.replace(/^###\s*(Q\d+.*?)$/gm, '**$1**');
    content = content.replace(/\*\*A\.\s(.*?)\*\*/g, 'A. $1');
    content = content.replace(/\*\*Q\d+\.\s(.*?)\*\*/g, 'Q. $1');

    // 3. ç¬¬1ç« ã¨ç¬¬2ç« ã®çµ±åˆ
    // æˆ¦ç•¥: "## 2ç« ï¼šæº–å‚™ãƒ•ã‚§ãƒ¼ã‚º" ã‚’å‰Šé™¤ã—ã€ãã®é…ä¸‹ã® "### 2.x" ã‚’ã™ã¹ã¦ã€é€£ç•ªã‚’ãƒªã‚»ãƒƒãƒˆã›ãšã¨ã‚‚
    // HTMLç”Ÿæˆå´ã®è‡ªå‹•æ¡ç•ªã«ä»»ã›ã‚‹å½¢ã«ã™ã‚‹ã€‚
    // ãã®ãŸã‚ã«ã€Markdownä¸Šã®ã€Œxç« ã€ã€Œx.xã€ã¨ã„ã†ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç•ªå·ã‚’ã™ã¹ã¦æ¶ˆã™ã€‚

    // "## 1ç« ï¼šVibe Coding..." -> "## Vibe Coding..."
    content = content.replace(/^##\s*\d+ç« \s*[:ï¼š]?\s*/gm, '## ');
    content = content.replace(/^##\s*0ç« \s*[:ï¼š]?\s*/gm, '## '); // 0ç« ã‚‚
    content = content.replace(/^##\s*ï¼™ç« \s*[:ï¼š]?\s*/gm, '## '); // å…¨è§’æ•°å­—å¯¾ç­–
    content = content.replace(/^##\s*\d+ç« \s*/gm, '## ');

    // "### 1.1 Vibe Codingã¨ã¯" -> "### Vibe Codingã¨ã¯"
    content = content.replace(/^###\s*[\d\.-]+\s*/gm, '### ');

    // ç¬¬2ç« ã®çµ±åˆ
    // "## æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆAIã¨ç’°å¢ƒã‚’æ•´ãˆã‚‹ï¼‰" ã¨ã„ã†è¦‹å‡ºã—ã‚’æ¢ã—ã¦å‰Šé™¤ã—ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Šã‚’ãªãã™
    // ãŸã ã—ã€è¦‹å‡ºã—è‡ªä½“ã¯æ®‹ã—ã¦ã€Œæº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã€ã¨ã„ã†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã—ãŸã„ã‹ã‚‚ã—ã‚Œãªã„
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œçµ±åˆã—ã¦ã„ã„ã€ã¨è¨€ã£ãŸã€‚
    // ãªã®ã§ã€è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«ã‚’ ### ã«ä¸‹ã’ã‚‹ã‹ã€ã‚‚ã—ãã¯å˜ãªã‚‹å¤ªå­—ãƒ†ã‚­ã‚¹ãƒˆã«ã™ã‚‹ã‹ã€‚
    // ã“ã“ã§ã¯ã€Œ## æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã€ã‚’å‰Šé™¤ã—ã¦ã€é…ä¸‹ã® ### ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç›´å‰ã®ç« ï¼ˆVibe Codingç« ï¼‰ã«ç¶šã‘ã‚‹å½¢ã«ã™ã‚‹ã€‚

    // ãŸã ã—ã€å˜ç´”ã«æ¶ˆã™ã¨æ–‡è„ˆãŒç¹‹ãŒã‚‰ãªã„ã®ã§ã€ã€Œ## æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã€ã‚’ã€Œ### æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã€ã«ç½®æ›ã—ã¦ã€
    // ç¬¬1ç« ã®ä¸­ã®1ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ‰±ã†ã‚ˆã†ã«ã™ã‚‹ã€‚
    content = content.replace(/^##\s*æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º/gm, '### æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º');

    // ä»–ã®ç« ã¯ ## ã®ã¾ã¾ãªã®ã§ã€çµæœã¨ã—ã¦
    // æ—§1ç«  (##)
    //   ...
    //   æ—§2ç«  (### ã«æ ¼ä¸‹ã’)
    // æ—§3ç«  (##) -> æ–°2ç« ã«ãªã‚‹

    // ã“ã‚Œã§HTMLç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå´ã§H2ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚Œã°ã€è‡ªå‹•çš„ã«ç« ç•ªå·ãŒç¹°ã‚Šä¸ŠãŒã‚‹ã€‚

    await fs.writeFile(OUTPUT_FILE, content);
    console.log(`Refined Markdown saved to ${OUTPUT_FILE}`);
}

refine();
